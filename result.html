
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <style>
        hr.solid {
            border-top: 3px solid #bbb;
        }


        body {
            background-color: #EEEEEE;
            color: black;
            font-family: Verdana;
        }

		.padding {
			padding-left: 10%;
			padding-right: 10%;
		}

        .banner {
            width: 100%;
            height: 50px; 
            background-size: cover;
            background-position: center;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }   
        
        .banner img {
            margin-top: 50px;
            background-color: #EEEEEE;
            position: relative;
            z-index: 1;
        }

        .test {
            background-color: blue;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>

<body>
    <div class="loading">
        <center> <h1> Loading, please wait... </h1> </center>
    
    </div>

<script>
var openAIKey = localStorage.getItem("openAIKey");;
if(openAIKey === null || openAIKey === "" || openAIKey === undefined) {
    openAIKey = prompt("Provide your OpenAI key here: ");
    localStorage.setItem("openAIKey", openAIKey);
}

function getQueryParam(param) {
   var urlParams = new URLSearchParams(location.search);
   return urlParams.get(param);
 }

var animeId = getQueryParam("id"); 

// Here we define our query as a multi-line string
// Storing it in a separate .graphql/.gql file is also possible
var query = `
query ($id: Int) { # Define which variables will be used in the query (id)
  Media (id: $id) { # Insert our variables into the query arguments (id) (type: ANIME is hard-coded in the query)
    id
    title {
      romaji
      english
      native
    }
    tags {
        name
    }
    reviews(limit: 5, sort: [SCORE], page: 1, perPage: 3) {
        nodes {
            summary
            score
            body
            user {
                name
                id
                avatar {
                    medium
                }
            }
            siteUrl
        }
            
    }
    description
    bannerImage
  }
}
`;

// Define our query variables and values that will be used in the query request
var variables = {
    id: parseInt(animeId)
};


var accessToken = localStorage.getItem("accessToken");

async function fetchData() {
    var options = {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

    try {
        
        const response = await fetch('https://graphql.anilist.co', options);

        const json = await handleResponse(response);
        var description = json.data.Media.description;
        var englishTitle = json.data.Media.title.english;
        var tags = json.data.Media.tags.map(tags => tags.name).join('<br> - ');

        var reviewSummary = json.data.Media.reviews.nodes.map(review => `${review.summary}`).join(' | ');


        //const openAIRecommender = await openAIResponse(tags, description);
        await handleData(json, null, tags, description, englishTitle, reviewSummary);

    } catch (error) {
        handleError(error);
    }
}

async function openAIResponse(tags, description) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that receives information about an anime and then recommends five anime based on it. Be very concise and give bulletpoints. Explain why you recommend it."
                    },
                    {
                        role: "user", content: `Recommend based on these tags: ${tags} AND this description: ${description}.`
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

async function openAIResponse2(description, englishTitle, reviewSummary) {
    var API_KEY = localStorage.getItem("openAIKey");
    var favoritesTitles = localStorage.getItem("favoritesTitles");
    console.log(favoritesTitles);
    console.log(englishTitle);

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that receives the user's favorite anime. Then, you need to give a one sentence answer for if you recommend the anime to them or not. You will get the synopsis of the anime. Use another short sentence to describe why you say so. If the anime is already in their favorites, mention it playfully. Mention if it is different than what they're used to. Caution the user if the anime is a sequel unless the user has the first season in their favorites. Don't assume the user hasn't watched the first season, just caution. Use a final short sentence to factor in AniList review summaries. If it is null, do not mention reviews at all."
                    },
                    {
                        role: "user", content: `Recommend (thumbs up or down emoji) based on this description: ${description}. This is the name of the anime: ${englishTitle} This is the user's favorites: ${favoritesTitles}. Take into account these AniList review summaries: ${reviewSummary}`
                    }]
            })
        });

        var data = await response.json();
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function handleData(data, openAIRecommender, tags, description, englishTitle, reviewSummary) {
    // document.write(`<a href="search.html"> <button type="button"> test </button></a>`);
    // console.log(data);
    var romajiTitle = data.data.Media.title.romaji;

    var banner = data.data.Media.bannerImage;

    // var bannerDiv = document.createElement('div');
    // bannerDiv.className = 'banner';
    // bannerDiv.style.backgroundImage = `url('${banner}')`;
    // document.body.appendChild(bannerDiv);

    localStorage.setItem("animeName",englishTitle);
    console.log(localStorage.getItem("animeName"));

    document.write(`
        <table bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td> <a href="index.html"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%" class="center"> <center> <h1> AniList 2 </h1></center>
            </tr>
        </table>           
            <br>`);

    document.write(`<img class="padding" src="${banner}" width="100%" height="200px" style="object-fit: cover"> <br>`);

    var nativeTitle = data.data.Media.title.native;
    const sentenceRecommend = await openAIResponse2(description, englishTitle, reviewSummary);
    //var reviewSummary = data.data.Media.reviews.nodes.summary;

    document.write(`
        <div class="padding">
            <center> <h1> ${englishTitle} </h1> </center>
           <div class="test" style="background-color: orange; padding: 5px 5px 15px 15px"> <h3> Recommended? </h3> ${sentenceRecommend}  </div>
            <h3> Titles </h3>
            Romaji Title: ${romajiTitle} <br>
            English Title: ${englishTitle} <br>
            Native Title: ${nativeTitle} <br>
        </div>
        <br>
        <div>
           ${description}
        </div>
    `);
    
    document.write(" <h3> Tags </h3>");
    document.write(`- ${tags} <br><br>`);

    document.write(" <center> <h2> Reviews </h2> </center>");
    var review = data.data.Media.reviews.nodes.map(review => `
        <p> <img src="${review.user.avatar.medium}" style="width: 5%"> <a href="https://anilist.co/user/${review.user.name}">${review.user.name}</a> <p>
        <p> Score: <b>${review.score}</b> <p> 
        <p> Summary: <a href="javascript:void(0);" class="review" data-id=${data.data.Media.id} user=${review.user.name}> ${review.summary} </a> </p> <br>
    `).join('<br><hr class="solid"> <br>');
    document.write(` ${review} <br> `);



    document.write("<center> <h2> Recommendations </h2> </center> <div id='recommendations'> </div>");

    document.body.innerHTML += `
    <button id="ai-recommend">Load Recommendations</button>
    `;

    document.getElementById("ai-recommend").addEventListener("click", async function() {
        this.disabled = true;
        this.textContent = "Loading recommendations...";
        const openAIRecommender = await openAIResponse(tags, description);
        document.getElementById("recommendations").innerHTML = `Recommendations: ${marked.parse(openAIRecommender)}`;
            this.textContent = "Done!";
        });

        document.querySelectorAll('.review').forEach(item => {
      item.addEventListener('click', event => {
        var animeId = event.target.closest('.review').getAttribute('data-id');
        localStorage.setItem("reviewUser", event.target.closest('.review').getAttribute('user'));
        console.log(animeId);
        console.log(localStorage.getItem("reviewUser"));
        window.location.href = `review.html?id=${animeId}?user=${localStorage.getItem("reviewUser")}`;
      });
    });
}

fetchData();

function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

</script>

</body>
</html>