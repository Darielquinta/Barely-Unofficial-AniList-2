<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        hr.solid {
            border-top: 3px solid #bbb;
        }
    
        .disabled {
            background-color: rgb(153, 0, 0);
            cursor: not-allowed;
        }
		
		.padding {
			padding-left: 10%;
			padding-right: 10%;
		}
		
		table {
			border-collapse: collapse;
            margin: 0;
            padding: 0;
            width: 100%;
		}
    </style>
</head>
<body >

    <div class="loading">
        <center> <h1> Loading, please wait... </h1> </center>
    
    </div>
<script>
var openAIKey = localStorage.getItem("openAIKey");;
if(openAIKey === null || openAIKey === "" || openAIKey === undefined) {
    openAIKey = prompt("Provide your OpenAI key here: ");
    localStorage.setItem("openAIKey", openAIKey);
}

let finalAnswer = "No answer";

var query = `
query {
    Viewer {
        name
        about
        avatar {
            medium
        }
        bannerImage
        favourites {
            anime {
                nodes {
                    id
                    title {
                        english
                    }
                }
            }
        }
        statistics {
            anime {
                scores(limit: 5 sort: [COUNT]) {
                    score
                }
                statuses(limit: 5 sort:[COUNT]) {
                    status
                }


            }
        }
    }
}
`;

var variables = {};

function getAccessToken() {
    var hash = window.location.hash.substring(1);
    var params = new URLSearchParams(hash);
    return params.get('access_token');
}



var accessToken = getAccessToken();
localStorage.setItem("accessToken", accessToken);
console.log(localStorage.getItem("accessToken"));

async function fetchData() {
    var options = {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

    try {
        const response = await fetch('https://graphql.anilist.co', options);
        const json = await handleResponse(response);

        const favoritesTitles = json.data.Viewer.favourites.anime.nodes.map(anime => `
    ${anime.title.english}
    `).join('<br> ');
    
        const openAIDescription = await openAIResponse(favoritesTitles);
        handleData(json, openAIDescription, favoritesTitles);
    } catch (error) {
        handleError(error);
    }
}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function openAIResponse(favoritesTitles) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that recommends anime based on the user's favorites. Be as concise as possible, creating a bullet list of 5."
                    },
                    {
                        role: "user", content: `Here are my favorite anime: ${favoritesTitles}`
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);  // Log the actual response content
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

function handleData(data, openAIDescription, favoritesTitles) {
    console.log(data.data.Viewer.statistics.anime.statuses.status);
    //        const favoritesTitles = json.data.Viewer.favourites.anime.nodes.map(anime => `${anime.title.english}`).join('<br> ');
    var animeScores = data.data.Viewer.statistics.anime.scores.map(score => ` Score: ${score.score}`).join('<br> ');
    var animeStatus = data.data.Viewer.statistics.anime.statuses.map(status => ` Status: ${status}`).join('<br> ');
    document.body.innerHTML = `
        <table class="padding" bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td style="padding: 0;"> <a href="index.html" class="padding"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%; padding: 0;"> <center><h1 style="margin: 0;"> AniList 2 </h1></center>
            </tr>
        </table>
        

        <img src=${data.data.Viewer.bannerImage} width=100%>
        <center> <h2> Authorized! Welcome back ${data.data.Viewer.name}! </h2> </center> <br>
        <center> <img src="${data.data.Viewer.avatar.medium}"> </center> <br>
        <p> About me: ${marked.parse(data.data.Viewer.about)} </p> <br>
        <p> Favorites: <br> ${favoritesTitles} </p> <br>
        <p>Recommendations: ${marked.parse(openAIDescription)}</p> <br>
        
        <p> ${animeScores} </p>
        
        <br> <br>`;

    console.log(getAccessToken());

    localStorage.setItem("favoritesTitles", favoritesTitles);
    console.log(localStorage.getItem("favoritesTitles"));
}



//<p>Recommendations: ${marked.parse(openAIDescription)}</p> <br>

function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

// Call fetchData when the script loads
fetchData();

</script>
</body>
</html>