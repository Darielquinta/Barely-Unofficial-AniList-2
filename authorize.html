<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        hr.solid {
            border-top: 3px solid #bbb;
        }
    
        .disabled {
            background-color: rgb(153, 0, 0);
            cursor: not-allowed;
        }
		
		.padding {
			padding-left: 10%;
			padding-right: 10%;
		}
		
		table {
			border-collapse: collapse;
            margin: 0;
            padding: 0;
            width: 100%;
		}

        #content {
            padding-left: 25%;
			padding-right: 25%;
        }

        body {
            margin: 0;
            padding: 0;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
        }
    </style>
</head>
<body>
    <div id="header"></div>

    <div id="content">
        <center> <h1> Loading, please wait... </h1> </center>
    
    </div>
<script>
var openAIKey = localStorage.getItem("openAIKey");;
if(openAIKey === null || openAIKey === "" || openAIKey === undefined) {
    openAIKey = prompt("Provide your OpenAI key here: ");
    localStorage.setItem("openAIKey", openAIKey);
}

let finalAnswer = "No answer";

var query = `
query ($page: Int, $perPage: Int, $userName: String) {
    Viewer {
        name
        about
        avatar {
            medium
            large
        }
        bannerImage
        favourites {
            anime {
                nodes {
                    id
                    title {
                        english
                    }
                }
            }
        }
        statistics {
            anime {
                scores(limit: 5 sort: [COUNT]) {
                    score
                }
                statuses(limit: 5 sort:[COUNT]) {
                    status
                }


            }
        }
    }

    Page (page: $page, perPage: $perPage) {
        pageInfo {
            total
            perPage
            hasNextPage
        }
        mediaList(type: ANIME, userName: $userName, sort: FINISHED_ON_DESC, status_in: COMPLETED) {
            media {
                id
                coverImage {
                    medium
                    large
                }
                title {
                    english
                    romaji
                }
            }
            status
            score(format: POINT_100)
            notes
            completedAt {
                year    
            }
        }
    }
}
`;
// mediaList  completedAt_greater: 20200500
    var variables = {
        userName: "Darielquinta",
        page: 1,
        perPage: 100
    };

function getAccessToken() {
    var hash = window.location.hash.substring(1);
    var params = new URLSearchParams(hash);
    return params.get('access_token');
}

var accessToken = getAccessToken();
localStorage.setItem("accessToken", accessToken);
// console.log(localStorage.getItem("accessToken"));

async function fetchData() {
    var allMediaList = [];
    var hasNextPage = true;
    var currentPage = 1;
    var viewerData = null;

    while(hasNextPage) {
        variables.page = currentPage;

        var options = {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                variables: variables
            })
        };

        try {
            const response = await fetch('https://graphql.anilist.co', options);
            const json = await handleResponse(response);
            
            allMediaList = allMediaList.concat(json.data.Page.mediaList);
            hasNextPage = json.data.Page.pageInfo.hasNextPage;
            currentPage++;

            if(!viewerData) {
                viewerData = json.data.Viewer;
            }
        } catch (error) {
            handleError(error);
            break;
        }
    }

    const favoritesTitles = viewerData.favourites.anime.nodes.map(anime => `
    ${anime.title.english}
    `).join('<br> ');

    handleData({ 
        data: { 
            Page: { mediaList: allMediaList },
            Viewer: viewerData
        } 
    }, null, favoritesTitles);

}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function openAIResponse(favoritesTitles) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that recommends anime based on the user's favorites. Be as concise as possible, creating a bullet list of 5. You must use marked markdown features."
                    },
                    {
                        role: "user", content: `Here are my favorite anime: ${favoritesTitles}.`,
                        
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);  // Log the actual response content
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

function handleData(data, openAIDescription, favoritesTitles) {
    console.log(data);
    // console.log(data.data.Page.mediaList.map(item => `${item.media.title.romaji}`).join('<br> <br> <hr class="solid">'));

    //console.log(data.data.Viewer.statistics.anime.statuses.status);
    //        const favoritesTitles = json.data.Viewer.favourites.anime.nodes.map(anime => `${anime.title.english}`).join('<br> ');
    var animeList = data.data.Page.mediaList.map(item => `<img src="${item.media.coverImage.medium}" style="width: 50px"/> <a href="https://buba2.co/result.html?id=${item.media.id}"> ${item.media.title.romaji} </a> <br> Score: <b> ${item.score} </b>`).join('<br> <br> <hr class="solid">');
        
    var animeNames = localStorage.getItem("animeList");

    if (animeNames === null || animeNames === "" || animeNames === undefined) {
        animeNames = data.data.Page.mediaList.map(item => `="https://buba2.co/result.html?id=${item.media.id}"> ${item.media.title.romaji} </a> <br> Score: <b> ${item.score} </b>`).join('<br> <br> <hr class="solid">');
        localStorage.setItem("animeList", animeNames);
    }






    document.getElementById('header').innerHTML = `
            <table class="padding" bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td style="padding: 0;"> <a href="index.html" class="padding"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%; padding: 20px;"> <center><h1 style="margin: 0;"> Barely Unofficial Bart's AniList 2 </h1></center>
            </tr>
        </table>
        <img src=${data.data.Viewer.bannerImage} width=100%>`;
        
    document.getElementById('content').innerHTML = `

        <center> <h1> Authorized! Welcome back ${data.data.Viewer.name}! </h1> </center> <br>
        <center> <img src="${data.data.Viewer.avatar.large}" style="height: 50%;"> </center> <br>
        <p> About me: ${marked.parse(data.data.Viewer.about)} </p> <br>
        <p> Favorites: <br> ${favoritesTitles} </p> <br>
        <center> <h3> Completed Anime List: </h3> </center><br> ${animeList}
        // 
        
        <br> <br>`;
    // console.log(animeList);
    //console.log(getAccessToken());
    //<p>Recommendations: ${marked.parse(openAIDescription)}</p> <br>

    localStorage.setItem("favoritesTitles", favoritesTitles);
    console.log(localStorage.getItem("favoritesTitles"));
}



//<p>Recommendations: ${marked.parse(openAIDescription)}</p> <br>

function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

// Call fetchData when the script loads
fetchData();

</script>
</body>
</html>