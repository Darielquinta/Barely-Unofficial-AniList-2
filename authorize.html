<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        hr.solid {
            border-top: 3px solid #bbb;
        }
    
        .disabled {
            background-color: rgb(153, 0, 0);
            cursor: not-allowed;
        }
		
		.padding {
			padding-left: 10%;
			padding-right: 10%;
		}
		
		table {
			border-collapse: collapse;
            margin: 0;
            padding: 0;
            width: 100%;
		}

        #content {
            padding-left: 25%;
			padding-right: 25%;
        }

        body {
            margin: 0;
            padding: 0;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
        }
    </style>
</head>
<body>
    <div id="header"></div>

    <div id="content">
        <center> <h1> Loading, please wait... </h1> </center>
    
    </div>
<script>
var openAIKey = localStorage.getItem("openAIKey");;
if(openAIKey === null || openAIKey === "" || openAIKey === undefined) {
    openAIKey = prompt("Provide your OpenAI key here: ");
    localStorage.setItem("openAIKey", openAIKey);
}

let finalAnswer = "No answer";

var query = `
query ($page: Int, $perPage: Int, $userName: String) {
    Viewer {
        name
        about
        avatar {
            medium
            large
        }
        bannerImage
        favourites {
            anime {
                nodes {
                    id
                    title {
                        english
                    }
                }
            }
        }
        statistics {
            anime {
                scores(limit: 5 sort: [COUNT]) {
                    score
                }
                statuses(limit: 5 sort:[COUNT]) {
                    status
                }


            }
        }
    }

    Page (page: $page, perPage: $perPage) {
        pageInfo {
            total
            perPage
            hasNextPage
        }
        mediaList(type: ANIME, userName: $userName, sort: FINISHED_ON_DESC, status_in: COMPLETED) {
            media {
                id
                coverImage {
                    medium
                    large
                }
                title {
                    english
                    romaji
                }
            }
            status
            score(format: POINT_100)
            notes
            completedAt {
                year    
            }
        }
    }
}
`;
// mediaList  completedAt_greater: 20200500
    var variables = {
        userName: "Darielquinta",
        page: 1,
        perPage: 50
    };

function getAccessToken() {
    var hash = window.location.hash.substring(1);
    var params = new URLSearchParams(hash);
    return params.get('access_token');
}

var accessToken = getAccessToken();
localStorage.setItem("accessToken", accessToken);
// console.log(localStorage.getItem("accessToken"));

async function getAnimeId(animeName) {
    var query = `
    query ($search: String) {
        Media (search: $search, type: ANIME) {
            id
            title {
                romaji
                native
                english
            }
            coverImage {
                medium
            }
            description
        }
    }
    `;

    var variables = {
        search: animeName
    };

    var options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

        const response = await fetch('https://graphql.anilist.co', options);
        const data = await response.json();
        if (data.data && data.data.Media) {
            return {
                id: data.data.Media.id,
                title: data.data.Media.title.romaji,
                coverImage: data.data.Media.coverImage.medium
            };
        } else {
            console.error('Anime not found:', animeName);
            return null;
        }

};

async function extractText(openAIDescription) {
    var pattern = /\*\*(.*?)\*\*/g; 
    var matches = openAIDescription.match(pattern);

    if (matches) {
        const extractedTitles = matches.map(match => match.replace(/^\*\*|\*\*$/g, '*').trim());
        
        for(var i = 0; i < extractedTitles.length; i++) {
            var id = await getAnimeId(extractedTitles[i]);
            // console.log(id.id);
            extractedTitles[i] = `<img src="${id.coverImage}" style="width: 50px" /> <a href="result.html?id=${id.id}" /> ${id.title} </a>`;
            // console.log(extractedTitles[i]);
            
        }

        // const finalTitles = extractedTitles.map(extractedTitles => extractedTitles.replace(/\*(.*?)\*/g, `<a href="review.html?id=${id}" />`).trim());
        //console.log(`Final anime: ${extractedTitles}`);
        //document.body.innerHTML += extractedTitles.join(`<br> `);
        return extractedTitles;
    } else {
        return "No recommendations found.";
    }
}

async function fetchData() {
    var allMediaList = [];
    var hasNextPage = true;
    var currentPage = 1;
    var viewerData = null;

    while(hasNextPage) {
        variables.page = currentPage;

        var options = {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                variables: variables
            })
        };

        try {
            const response = await fetch('https://graphql.anilist.co', options);
            const json = await handleResponse(response);
            
            allMediaList = allMediaList.concat(json.data.Page.mediaList);
            hasNextPage = json.data.Page.pageInfo.hasNextPage;
            currentPage++;

            if(!viewerData) {
                viewerData = json.data.Viewer;
            }
        } catch (error) {
            handleError(error);
            break;
        }
    }   

    

    const favoritesTitles = viewerData.favourites.anime.nodes.map(anime => `
    ${anime.title.english}
    `).join('<br> ');

    const openAIDescription = await openAIResponse(favoritesTitles);
    const extractedTitles = await extractText(openAIDescription);
    handleData({ 
        data: { 
            Page: { mediaList: allMediaList },
            Viewer: viewerData
        } 
    }, openAIDescription, favoritesTitles, extractedTitles);

}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function openAIResponse(favoritesTitles) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that recommends anime based on the user's favorites and completed anime list. Make sure NONE of your recommendations are in the completed anime list. Be as concise as possible, creating a bullet list of 5. Make sure the title is exact. They should be the exact AniList names. English titles only. Put the anime names between two asterisks."
                    },
                    {
                        role: "user", content: `Here are my favorite anime: ${favoritesTitles}. Here is my completed anime list: ${localStorage.getItem("animeList")}. Don't include any of these in your recommendation.`,
                        
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);  // Log the actual response content
        console.log(localStorage.getItem("animeList"));
        var extractedRecommendations = await extractText(data.choices[0].message.content);
        //console.log(`Recommendations (only titles): ${extractedRecommendations}`);
        return data.choices[0].message.content;

    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}


function handleData(data, openAIDescription, favoritesTitles, extractedTitles) {
    console.log(data);
    // console.log(data.data.Page.mediaList.map(item => `${item.media.title.romaji}`).join('<br> <br> <hr class="solid">'));

    //console.log(data.data.Viewer.statistics.anime.statuses.status);
    //        const favoritesTitles = json.data.Viewer.favourites.anime.nodes.map(anime => `${anime.title.english}`).join('<br> ');
    var animeList = data.data.Page.mediaList.map(item => `<img src="${item.media.coverImage.medium}" style="width: 50px"/> <a href="https://buba2.co/result.html?id=${item.media.id}"> ${item.media.title.romaji} </a> <br> Score: <b> ${item.score} </b>`).join('<br> <br> <hr class="solid">');
        
    var animeNames = localStorage.getItem("animeList");

    if (animeNames === null || animeNames === "" || animeNames === undefined) {
        animeNames = data.data.Page.mediaList.map(item => `<img src="https://buba2.co/result.html?id=${item.media.id}"> ${item.media.title.romaji} </a> <br> Score: <b> ${item.score} </b>`).join('<br> <br> <hr class="solid">');
        localStorage.setItem("animeList", animeNames);
    }

    animeListTitles = data.data.Page.mediaList.map(item => `${item.media.title.romaji} Score: ${item.score}`).join(', ');
    localStorage.setItem("animeList", animeListTitles);






    document.getElementById('header').innerHTML = `
            <table class="padding" bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td style="padding: 0;"> <a href="index.html" class="padding"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%; padding: 20px;"> <center><h1 style="margin: 0;"> Barely Unofficial Bart's AniList 2 </h1></center>
            </tr>
        </table>
        <img src=${data.data.Viewer.bannerImage} width=100%>`;
        
    document.getElementById('content').innerHTML = `

        <center> <h1> Authorized! Welcome back ${data.data.Viewer.name}! </h1> </center> <br>
        <center> <img src="${data.data.Viewer.avatar.large}" style="height: 50%;"> </center> <br>
        <center> <h2> About Me: </h2> </center> ${marked.parse(data.data.Viewer.about)} <br>
        <center> <h2> Recommendations: </h2> </center> <br> ${extractedTitles.join(`<br>`)}  <br> 
        <center> <h2> Favorites: </h2> </center> <br> ${favoritesTitles} <br>
        <center> <h2> Completed Anime List: </h2> </center><br> ${animeList}

        
        <br> <br>`;
    // console.log(animeList);
    //console.log(getAccessToken());
    //

    localStorage.setItem("favoritesTitles", favoritesTitles);
    //console.log(localStorage.getItem("favoritesTitles"));
}



//<p>Recommendations: ${marked.parse(openAIDescription)}</p> <br>

function handleError(error) {
    window.location.href = "https://anilist.co/api/v2/oauth/authorize?client_id=19817&response_type=token";
    alert('Error, check console lol');
    console.error(error);
}

// Call fetchData when the script loads
fetchData();

</script>
</body>
</html>