
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
    hr.solid {
        border-top: 3px solid #bbb;
    }

    .review {
        text-wrap: wrap;
    }


</style>
</head>

<body>
<script>

function getQueryParam(param) {
   var urlParams = new URLSearchParams(location.search);
   return urlParams.get(param);
 }

var animeId = getQueryParam("id"); 
var reviewUser = getQueryParam("review.nodes.user.name");
// console.log("animeID: " + animeId);
//console.log("parseInt(animeID): " + typeof(parseInt(animeId)));



// Here we define our query as a multi-line string
// Storing it in a separate .graphql/.gql file is also possible
var query = `
query ($id: Int) { # Define which variables will be used in the query (id)
  Media (id: $id) { # Insert our variables into the query arguments (id) (type: ANIME is hard-coded in the query)
    id
    title {
      romaji
      english
      native
    }
    tags {
        name
    }
    reviews(limit: 5, sort: [SCORE], page: 1, perPage: 3) {
        nodes {
            summary
            score
            body
            user {
                name
                id
                avatar {
                    medium
                }
            }
            siteUrl
        }
            
    }
    bannerImage
  }
}
`;

// Define our query variables and values that will be used in the query request
var variables = {
    id: parseInt(animeId)
};

// Define the config we'll need for our Api request
var url = 'https://graphql.anilist.co',
    options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

// Make the HTTP Api request
fetch(url, options).then(handleResponse)
                   .then(handleData)
                   .catch(handleError);

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

function handleData(data) {
    document.write(`
        <table bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td> <a href="index.html"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%" class="center"> <center> <h1> AniList 2 </h1></center>

            </tr>

        </table>           
            <br>`);
        
    reviewUser = localStorage.getItem("reviewUser");
  // document.write(`<a href="search.html"> <button type="button"> test </button></a>`);
    console.log(data);
    var banner = data.data.Media.bannerImage;
    console.log(banner)


    var nativeTitle = data.data.Media.title.native;
    //var reviewSummary = data.data.Media.reviews.nodes.summary;
    document.write(`<img src="${banner}" width="100%" height="0%"> <br>`);

    var selectedReview = data.data.Media.reviews.nodes.find(review => review.user.name === reviewUser);

    if(selectedReview) {
        document.write(`
         <p> <a href="https://anilist.co/user/${selectedReview.user.name}"> <img src="${selectedReview.user.avatar.medium}" style="width: 5%"> ${selectedReview.user.name}</a> <p>
        <p> Score: <b>${selectedReview.score}</b> <p> 
        <p> Summary:  ${selectedReview.summary} </p> <br>
        <div class="review"> Review: ${marked.parse(selectedReview.body)} </div>
        `)
    }

    //document.write(` ${review} <br> `);

}

function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

</script>

</body>
</html>