<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
    hr.solid {
        border-top: 3px solid #bbb;
    }

    .review {
        text-wrap: wrap;
    }
    </style>
</head>

<body>
<script>
var openAIKey = localStorage.getItem("openAIKey");;
if(openAIKey === null || openAIKey === "" || openAIKey === undefined) {
    openAIKey = prompt("Provide your OpenAI key here: ");
    localStorage.setItem("openAIKey", openAIKey);
}

function getQueryParam(param) {
   var urlParams = new URLSearchParams(location.search);
   return urlParams.get(param);
}

var animeId = getQueryParam("id"); 
var reviewUser = getQueryParam("review.nodes.user.name");

var query = `
query ($id: Int) {
  Media (id: $id) {
    id
    title {
      romaji
      english
      native
    }
    tags {
        name
    }
    reviews(limit: 5, sort: [SCORE], page: 1, perPage: 3) {
        nodes {
            summary
            score
            body
            user {
                name
                id
                avatar {
                    medium
                }
            }
            siteUrl
        }
    }
    bannerImage
  }
}
`;

var variables = {
    id: parseInt(animeId)
};

async function fetchData() {
    var options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

    try {
        const response = await fetch('https://graphql.anilist.co', options);
        const json = await handleResponse(response);

        reviewUser = localStorage.getItem("reviewUser");
        console.log(`reviewUser: ${reviewUser}`);
        var selectedReview = json.data.Media.reviews.nodes.find(review => review.user.name === reviewUser);
        handleData(json, selectedReview);

    } catch (error) {
        handleError(error);
    }
}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function openAIResponse(reviewText) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that summarizes a review in a few sentences. Write it in their voice. Make sure it is one paragraph long."
                    },
                    {
                        role: "user", content: `Summarize this review: ${reviewText}`
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

function handleData(data, selectedReview) {
    console.log(selectedReview);
    document.body.innerHTML = `
        <table bgcolor="C0C0C0" style="width: 100%">
            <tr>
                <td> <a href="index.html"> <img src="https://static-00.iconduck.com/assets.00/search-icon-2048x2048-cmujl7en.png" style="width:40px"> </a>
                <td style="width: 100%" class="center"> <center> <h1> AniList 2 </h1></center>
            </tr>
        </table>
        <br>
        <img src="${data.data.Media.bannerImage}" width="100%" height="0%"> <br>
    `;

    if(selectedReview) {
        document.body.innerHTML += `
         <p> <a href="https://anilist.co/user/${selectedReview.user.name}"> <img src="${selectedReview.user.avatar.medium}" style="width: 5%"> ${selectedReview.user.name}</a> </p>
        <p> Score: <b>${selectedReview.score}</b> </p> 
        <button id="deyap">De-yappifier</button>
        <p> Summary: ${selectedReview.summary} </p> <br>
        <div id="reviewContent" class="review">Review: ${marked.parse(selectedReview.body)}</div>
        `;
       
        document.getElementById("deyap").addEventListener("click", async function() {
            this.disabled = true;
            this.textContent = "De-yapping...";
            const deyappedReview = await openAIResponse(selectedReview.body);
            document.getElementById("reviewContent").innerHTML = `De-yapped Review: ${deyappedReview}`;
            this.textContent = "De-yapped!";
        });
    } else {
        document.body.innerHTML += `<p>No review found for this user.</p>`;
    }
}

function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

fetchData();
</script>
</body>
</html>