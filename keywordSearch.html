<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <style>
        hr.solid {
            border-top: 3px solid #bbb;
        }
    
        .disabled {
            background-color: rgb(153, 0, 0);
            cursor: not-allowed;
        }
		
		.padding {
			padding-left: 10%;
			padding-right: 10%;
		}
		
		table {
			border-collapse: collapse;
            margin: 0;
            padding: 0;
            width: 100%;
		}

        #next-page, #previous-page {
            margin: auto;
            width: 50%;
            padding: 10px;
            background-color: #3CBC8D;
            color: white;
            border: none;
            padding: 16px 32px;

            font-size: large;
        }

    </style>
</head>
<body>
    <center>
        <form id="form"> 
            <input type="text" id="keyword"/>
            <input type="button" onclick="addKeyword()" value="Search" />
        </form>
    </center>
<script>
var keywords = [];
var id;
var bannerImage;
var description;

function addKeyword() {

    var input = document.getElementById('keyword').value;
    keywords.push(input);
    console.log(keywords);
    document.body.innerHTML += `- ${input} <br>`;

    handleData();

    document.getElementById('keyword').value = '';

    return keywords;
}

async function getAnimeId(animeName) {
    var query = `
    query ($search: String) {
        Media (search: $search, type: ANIME) {
            id
            title {
                english
            }
            bannerImage
            description
        }
    }
    `;

    var variables = {
        search: animeName
    };

    var options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

    try {
        const data = await graphQL(query, variables);
        id = data.data.Media.id;
        bannerImage = data.data.Media.bannerImage;
        description = data.data.Media.description;
        return data.data.Media.id;
    } catch (error) {
        handleError(error);
    }
};

async function graphQL(query, variables) {
    var options = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({
            query: query,
            variables: variables
        })
    };

    try {
        const response = await fetch('https://graphql.anilist.co', options);
        
        return await response.json();
    } catch (error) {
        handleError(error);
    }

};

async function openAIResponse(keywords) {
    var API_KEY = localStorage.getItem("openAIKey");

    try {
        var response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "system",
                        content: "You are an assistant that receives a few keywords and you need to recommend one anime that fits those keywords. Your response should ONLY be the name of the anime."
                    },
                    {
                        role: "user", content: `Use these keywords: ${keywords}`
                    }]
            })
        });

        var data = await response.json();
        console.log(data.choices[0].message.content);
        return data.choices[0].message.content;
    } catch (error) {
        console.error('Error:', error);
        return "An error occurred while fetching the response.";
    }
}

function handleResponse(response) {
    return response.json().then(function (json) {
        return response.ok ? json : Promise.reject(json);
    });
}

async function handleData() {
    
    console.log(`Current keywords: ${keywords.join(', ')}`)
    const anime = await openAIResponse(keywords.join(", "));
    var animeID = await getAnimeId(anime);
    var animeName = document.createElement('div');
    animeName.className = 'banner';
    animeName.textContent = anime;
    document.body.appendChild(animeName);
    document.body.innerHTML += `<img src="${bannerImage}"> test`;
    document.body.innerHTML += `${description} test`;

    console.log(`ID: ${id}`)
    
}



function handleError(error) {
    alert('Error, check console lol');
    console.error(error);
}

</script>




</body>
</html>